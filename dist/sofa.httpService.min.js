/**
 * sofa-http-service - v0.3.0 - 2014-03-27
 * http://www.sofa.io
 *
 * Copyright (c) 2013 CouchCommerce GmbH (http://www.couchcommerce.org) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA SDK (SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b,c){"use strict";a.define("sofa.HttpService",function(d){function e(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")}function f(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1}function g(a,b,c){return z(c)?c(a,b):(D(c,function(c){a=c(a,b)}),a)}function h(a){return a>=200&&300>a}function i(){return new XMLHttpRequest}function j(a){var b=y(a)?a:c;return function(c){return b||(b=k(a)),c?b[G(c)]||null:b}}function k(a){var b,c,d,e={};return a?(D(a.split("\n"),function(a){d=a.indexOf(":"),b=G(I(a.substr(0,d))),c=I(a.substr(d+1)),b&&(e[b]?e[b]+=", "+c:e[b]=c)}),e):e}function l(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b.sort()}function m(a,b,c){for(var d=l(a),e=0;e<d.length;e++)b.call(c,a[d[e]],d[e]);return d}function n(a,b){if(!b)return a;var c=[];return m(b,function(a,b){null===a||A(a)||(C(a)||(a=[a]),D(a,function(a){y(a)&&(a=x(a)),c.push(e(b)+"="+e(a))}))}),c.length>0&&(a+=(-1===a.indexOf("?")?"?":"&")+c.join("&")),a}function o(a,b,c){function e(a,b,c){l&&(h(a)?l.put(r,[a,b,k(c)]):l.remove(r)),g(b,a,c)}function g(b,c,d){c=Math.max(c,0),(h(c)?o.resolve:o.reject)({data:b,status:c,headers:j(d),config:a})}function i(){var b=f(K.pendingRequests,a);-1!==b&&K.pendingRequests.splice(b,1)}var l,m,o=d.defer(),q=o.promise,r=n(a.url,a.params);return K.pendingRequests.push(a),q.then(i,i),A(m)&&p(a.method,r,b,e,c,a.timeout,a.withCredentials,a.responseType),q}function p(a,b,c,d,e,f,g,h){function j(a,b,c,d){o=p=null,b=0===b?c?200:404:b,a(b,c,d)}function k(a,b){var c=v.createElement("script"),d=function(){c.onreadystatechange=c.onload=c.onerror=null,v.body.removeChild(c),b&&b()};return c.type="text/javascript",c.src=a,c.onload=c.onerror=function(){d()},v.body.appendChild(c),d}var l;b=b;var m=K.callbacks;if("jsonp"===G(a)){var n="_"+(m.counter++).toString(36);m[n]=function(a){m[n].data=a};var o=k(b.replace("JSON_CALLBACK","sofa.callbacks."+n),function(){m[n].data?j(d,200,m[n].data):j(d,l||-2),m[n]=function(){}})}else{var p=i(a);if(p.open(a,b,!0),D(e,function(a,b){B(a)&&p.setRequestHeader(b,a)}),p.onreadystatechange=function(){if(p&&4===p.readyState){var a=null,b=null;l!==u&&(a=p.getAllResponseHeaders(),b="response"in p?p.response:p.responseText),j(d,l||p.status,b,a)}},h)try{p.responseType=h}catch(q){if("json"!==h)throw q}p.send(c||null)}}var q=/^\s*(\[|\{[^\{])/,r=/[\}\]]\s*$/,s=/^\)\]\}',?\n/,t={"Content-Type":"application/json;charset=utf-8"},u=-1,v=b.document,w=a.Util.isString,x=a.Util.toJson,y=a.Util.isObject,z=a.Util.isFunction,A=a.Util.isUndefined,B=function(a){return!A(a)},C=a.Util.isArray,D=a.Util.forEach,E=a.Util.extend,F=function(b){return a.Util.isString(b)?JSON.parse(b):b},G=function(a){return w(a)?a.toLowerCase():a},H=function(a){return w(a)?a.toUpperCase():a},I=function(a){return w(a)?a.trim():a},J=this.defaults={transformResponse:[function(a){return w(a)&&(a=a.replace(s,""),q.test(a)&&r.test(a)&&(a=F(a))),a}],transformRequest:[function(a){return y(a)?x(a):a}],headers:{common:{Accept:"application/json, text/plain, */*"},post:a.Util.clone(t),put:a.Util.clone(t),patch:a.Util.clone(t)},xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN"},K=function(a){function b(a){var b=E({},a,{data:g(a.data,a.headers,f.transformResponse)});return h(a.status)?b:d.reject(b)}function e(a){function b(a){var b;D(a,function(c,d){z(c)&&(b=c(),null!==b?a[d]=b:delete a[d])})}var c,d,e,f=J.headers,g=E({},a.headers);f=E({},f.common,f[G(a.method)]),b(f),b(g);a:for(c in f){d=G(c);for(e in g)if(G(e)===d)continue a;g[c]=f[c]}return g}var f={method:"get",transformRequest:J.transformRequest,transformResponse:J.transformResponse},i=e(a);E(f,a),f.headers=i,f.method=H(f.method);for(var k=function(a){i=a.headers;var c=g(a.data,j(i),a.transformRequest);return A(a.data)&&D(i,function(a,b){"content-type"===G(b)&&delete i[b]}),A(a.withCredentials)&&!A(J.withCredentials)&&(a.withCredentials=J.withCredentials),o(a,c,i).then(b,b)},l=[k,c],m=d.when(f);l.length;){var n=l.shift(),p=l.shift();m=m.then(n,p)}return m};K.pendingRequests=[],K.callbacks={counter:0},K.defaults=J;var L=function(){D(arguments,function(a){K[a]=function(b,c){return K(E(c||{},{method:a,url:b}))}})},M=function(){D(arguments,function(a){K[a]=function(b,c,d){return K(E(d||{},{method:a,url:b,data:c}))}})};return L("get","jsonp"),M("post"),K})}(sofa,window);