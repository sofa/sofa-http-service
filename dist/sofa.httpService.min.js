/**
 * sofa-http-service - v0.1.0 - 2014-03-24
 * http://www.sofa.io
 *
 * Copyright (c) 2013 CouchCommerce GmbH (http://www.couchcommerce.org) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA SDK (SOFA.IO).
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(a,b){"use strict";a.define("sofa.HttpService",function(c){function d(a,b){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,b?"%20":"+")}function e(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0;c<a.length;c++)if(b===a[c])return c;return-1}function f(a,b,c){return x(c)?c(a,b):(B(c,function(c){a=c(a,b)}),a)}function g(a){return a>=200&&300>a}function h(){return new XMLHttpRequest}function i(a){var c=w(a)?a:b;return function(b){return c||(c=j(a)),b?c[E(b)]||null:c}}function j(a){var b,c,d,e={};return a?(B(a.split("\n"),function(a){d=a.indexOf(":"),b=E(G(a.substr(0,d))),c=G(a.substr(d+1)),b&&(e[b]?e[b]+=", "+c:e[b]=c)}),e):e}function k(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b.sort()}function l(a,b,c){for(var d=k(a),e=0;e<d.length;e++)b.call(c,a[d[e]],d[e]);return d}function m(a,b){if(!b)return a;var c=[];return l(b,function(a,b){null===a||y(a)||(A(a)||(a=[a]),B(a,function(a){w(a)&&(a=v(a)),c.push(d(b)+"="+d(a))}))}),c.length>0&&(a+=(-1===a.indexOf("?")?"?":"&")+c.join("&")),a}function n(a,b,d){function f(a,b,c){l&&(g(a)?l.put(r,[a,b,j(c)]):l.remove(r)),h(b,a,c)}function h(b,c,d){c=Math.max(c,0),(g(c)?p.resolve:p.reject)({data:b,status:c,headers:i(d),config:a})}function k(){var b=e(I.pendingRequests,a);-1!==b&&I.pendingRequests.splice(b,1)}var l,n,p=c.defer(),q=p.promise,r=m(a.url,a.params);return I.pendingRequests.push(a),q.then(k,k),y(n)&&o(a.method,r,b,f,d,a.timeout,a.withCredentials,a.responseType),q}function o(a,b,c,d,e,f,g,i){function j(a,b,c,d){b=0===b?c?200:404:b,a(b,c,d)}var k;b=b;var l=h(a);if(l.open(a,b,!0),B(e,function(a,b){z(a)&&l.setRequestHeader(b,a)}),l.onreadystatechange=function(){if(l&&4===l.readyState){var a=null,b=null;k!==t&&(a=l.getAllResponseHeaders(),b="response"in l?l.response:l.responseText),j(d,k||l.status,b,a)}},i)try{l.responseType=i}catch(m){if("json"!==i)throw m}l.send(c||null)}var p=/^\s*(\[|\{[^\{])/,q=/[\}\]]\s*$/,r=/^\)\]\}',?\n/,s={"Content-Type":"application/json;charset=utf-8"},t=-1,u=a.Util.isString,v=a.Util.toJson,w=a.Util.isObject,x=a.Util.isFunction,y=a.Util.isUndefined,z=function(a){return!y(a)},A=a.Util.isArray,B=a.Util.forEach,C=a.Util.extend,D=function(b){return a.Util.isString(b)?JSON.parse(b):b},E=function(a){return u(a)?a.toLowerCase():a},F=function(a){return u(a)?a.toUpperCase():a},G=function(a){return u(a)?a.trim():a},H=this.defaults={transformResponse:[function(a){return u(a)&&(a=a.replace(r,""),p.test(a)&&q.test(a)&&(a=D(a))),a}],transformRequest:[function(a){return w(a)?v(a):a}],headers:{common:{Accept:"application/json, text/plain, */*"},post:a.Util.clone(s),put:a.Util.clone(s),patch:a.Util.clone(s)},xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN"},I=function(a){function d(a){var b=C({},a,{data:f(a.data,a.headers,h.transformResponse)});return g(a.status)?b:c.reject(b)}function e(a){function b(a){var b;B(a,function(c,d){x(c)&&(b=c(),null!==b?a[d]=b:delete a[d])})}var c,d,e,f=H.headers,g=C({},a.headers);f=C({},f.common,f[E(a.method)]),b(f),b(g);a:for(c in f){d=E(c);for(e in g)if(E(e)===d)continue a;g[c]=f[c]}return g}var h={method:"get",transformRequest:H.transformRequest,transformResponse:H.transformResponse},j=e(a);C(h,a),h.headers=j,h.method=F(h.method);for(var k=function(a){j=a.headers;var b=f(a.data,i(j),a.transformRequest);return y(a.data)&&B(j,function(a,b){"content-type"===E(b)&&delete j[b]}),y(a.withCredentials)&&!y(H.withCredentials)&&(a.withCredentials=H.withCredentials),n(a,b,j).then(d,d)},l=[k,b],m=c.when(h);l.length;){var o=l.shift(),p=l.shift();m=m.then(o,p)}return m};I.pendingRequests=[];var J=function(){B(arguments,function(a){I[a]=function(b,c){return I(C(c||{},{method:a,url:b}))}})};return J("get"),I})}(sofa);